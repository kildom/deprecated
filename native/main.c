
#include <stdint.h>
#include <stdbool.h>
#include <stdlib.h>
#include <stdio.h>
#include <malloc.h>
#include <string.h>
#include <math.h>
#include <time.h>

int width = 1608;
int height = 1608;

int indexes[49][49] = {
    { 15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,14,14,14,14,14,13,13,13,13,13,13,13,12,12,12,12,12,12,12,13,13,13,13,13,13,13,14,14,14,14,14,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,14,14,14,14,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,14,14,14,14,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,14,14,14,14,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,14,14,14,14,13,13,13,13,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,15,15 },
    { 15,15,15,15,15,14,14,14,14,13,13,13,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,13,13,13,14,14,14,14,15,15,15,15,15 },
    { 15,15,15,15,14,14,14,14,13,13,13,12,12,12,12,11,11,11,11,11,10,10,10,10,10,10,10,10,10,11,11,11,11,11,12,12,12,12,13,13,13,14,14,14,14,15,15,15,15 },
    { 15,15,15,14,14,14,14,13,13,13,12,12,12,12,11,11,11,11,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,12,12,12,12,13,13,13,14,14,14,14,15,15,15 },
    { 15,15,15,14,14,14,13,13,13,12,12,12,12,11,11,11,10,10,10,10,10, 9, 9, 9, 9, 9, 9, 9,10,10,10,10,10,11,11,11,12,12,12,12,13,13,13,14,14,14,15,15,15 },
    { 15,15,14,14,14,14,13,13,13,12,12,12,11,11,11,10,10,10, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,14,15,15 },
    { 15,15,14,14,14,13,13,13,12,12,12,11,11,11,10,10,10, 9, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,15,15 },
    { 15,14,14,14,14,13,13,12,12,12,11,11,11,10,10,10, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9,10,10,10,11,11,11,12,12,12,13,13,14,14,14,14,15 },
    { 15,14,14,14,13,13,13,12,12,12,11,11,10,10,10, 9, 9, 8, 8, 8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 9, 9,10,10,10,11,11,12,12,12,13,13,13,14,14,14,15 },
    { 15,14,14,14,13,13,13,12,12,11,11,11,10,10, 9, 9, 8, 8, 8, 7, 7, 7, 6, 6, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9,10,10,11,11,11,12,12,13,13,13,14,14,14,15 },
    { 15,14,14,13,13,13,12,12,12,11,11,10,10, 9, 9, 9, 8, 8, 7, 7, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 8, 8, 9, 9, 9,10,10,11,11,12,12,12,13,13,13,14,14,15 },
    { 14,14,14,13,13,13,12,12,11,11,11,10,10, 9, 9, 8, 8, 7, 7, 6, 6, 5, 5, 5, 5, 5, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9,10,10,11,11,11,12,12,13,13,13,14,14,14 },
    { 14,14,14,13,13,13,12,12,11,11,10,10,10, 9, 9, 8, 7, 7, 6, 6, 5, 5, 4, 4, 4, 4, 4, 5, 5, 6, 6, 7, 7, 8, 9, 9,10,10,10,11,11,12,12,13,13,13,14,14,14 },
    { 14,14,14,13,13,12,12,12,11,11,10,10, 9, 9, 8, 8, 7, 7, 6, 5, 5, 4, 3, 3, 3, 3, 3, 4, 5, 5, 6, 7, 7, 8, 8, 9, 9,10,10,11,11,12,12,12,13,13,14,14,14 },
    { 14,14,14,13,13,12,12,12,11,11,10,10, 9, 9, 8, 8, 7, 6, 6, 5, 4, 3, 2, 2, 1, 2, 2, 3, 4, 5, 6, 6, 7, 8, 8, 9, 9,10,10,11,11,12,12,12,13,13,14,14,14 },
    { 14,14,14,13,13,12,12,12,11,11,10,10, 9, 9, 8, 8, 7, 6, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 6, 7, 8, 8, 9, 9,10,10,11,11,12,12,12,13,13,14,14,14 },
    { 14,14,14,13,13,12,12,12,11,11,10,10, 9, 9, 8, 8, 7, 6, 6, 5, 4, 3, 1, 0, 0, 0, 1, 3, 4, 5, 6, 6, 7, 8, 8, 9, 9,10,10,11,11,12,12,12,13,13,14,14,14 },
    { 14,14,14,13,13,12,12,12,11,11,10,10, 9, 9, 8, 8, 7, 6, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 6, 7, 8, 8, 9, 9,10,10,11,11,12,12,12,13,13,14,14,14 },
    { 14,14,14,13,13,12,12,12,11,11,10,10, 9, 9, 8, 8, 7, 6, 6, 5, 4, 3, 2, 2, 1, 2, 2, 3, 4, 5, 6, 6, 7, 8, 8, 9, 9,10,10,11,11,12,12,12,13,13,14,14,14 },
    { 14,14,14,13,13,12,12,12,11,11,10,10, 9, 9, 8, 8, 7, 7, 6, 5, 5, 4, 3, 3, 3, 3, 3, 4, 5, 5, 6, 7, 7, 8, 8, 9, 9,10,10,11,11,12,12,12,13,13,14,14,14 },
    { 14,14,14,13,13,13,12,12,11,11,10,10,10, 9, 9, 8, 7, 7, 6, 6, 5, 5, 4, 4, 4, 4, 4, 5, 5, 6, 6, 7, 7, 8, 9, 9,10,10,10,11,11,12,12,13,13,13,14,14,14 },
    { 14,14,14,13,13,13,12,12,11,11,11,10,10, 9, 9, 8, 8, 7, 7, 6, 6, 5, 5, 5, 5, 5, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9,10,10,11,11,11,12,12,13,13,13,14,14,14 },
    { 15,14,14,13,13,13,12,12,12,11,11,10,10, 9, 9, 9, 8, 8, 7, 7, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 8, 8, 9, 9, 9,10,10,11,11,12,12,12,13,13,13,14,14,15 },
    { 15,14,14,14,13,13,13,12,12,11,11,11,10,10, 9, 9, 8, 8, 8, 7, 7, 7, 6, 6, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9,10,10,11,11,11,12,12,13,13,13,14,14,14,15 },
    { 15,14,14,14,13,13,13,12,12,12,11,11,10,10,10, 9, 9, 8, 8, 8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 9, 9,10,10,10,11,11,12,12,12,13,13,13,14,14,14,15 },
    { 15,14,14,14,14,13,13,12,12,12,11,11,11,10,10,10, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9,10,10,10,11,11,11,12,12,12,13,13,14,14,14,14,15 },
    { 15,15,14,14,14,13,13,13,12,12,12,11,11,11,10,10,10, 9, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,15,15 },
    { 15,15,14,14,14,14,13,13,13,12,12,12,11,11,11,10,10,10, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,14,15,15 },
    { 15,15,15,14,14,14,13,13,13,12,12,12,12,11,11,11,10,10,10,10,10, 9, 9, 9, 9, 9, 9, 9,10,10,10,10,10,11,11,11,12,12,12,12,13,13,13,14,14,14,15,15,15 },
    { 15,15,15,14,14,14,14,13,13,13,12,12,12,12,11,11,11,11,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,12,12,12,12,13,13,13,14,14,14,14,15,15,15 },
    { 15,15,15,15,14,14,14,14,13,13,13,12,12,12,12,11,11,11,11,11,10,10,10,10,10,10,10,10,10,11,11,11,11,11,12,12,12,12,13,13,13,14,14,14,14,15,15,15,15 },
    { 15,15,15,15,15,14,14,14,14,13,13,13,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,13,13,13,14,14,14,14,15,15,15,15,15 },
    { 15,15,15,15,15,15,14,14,14,14,13,13,13,13,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,14,14,14,14,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,14,14,14,14,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,14,14,14,14,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,14,14,14,14,14,13,13,13,13,13,13,13,12,12,12,12,12,12,12,13,13,13,13,13,13,13,14,14,14,14,14,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15 },
    { 15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15 },
};

typedef struct
{
    uint32_t count;
    uint32_t sum;
    uint64_t sum_of_square;
} Sample;

Sample samples[16];

static inline void calc_for_point(uint16_t* buffer, int x, int y, uint32_t* output) {
    int xx, yy, i;
    x -= 24;
    y -= 24;
    for (i = 0; i < 16; i++) {
        samples[i].sum = 0;
        samples[i].sum_of_square = 0;
    }
    for (yy = 0; yy < 49; yy++) {
        for (xx = 0; xx < 49; xx++) {
            int index = indexes[yy][xx];
            uint32_t value = buffer[x + xx + (y + yy) * width];
            samples[index].sum += value;
            samples[index].sum_of_square += (uint64_t)(value * value);
        }
    }
    for (i = 0; i < 16; i++) {
        output[2 * i] = samples[i].sum / samples[i].count;
        uint64_t count2 = samples[i].count * samples[i].count;
        uint64_t sum = samples[i].sum;
        output[2 * i + 1] = (uint32_t)sqrt(((uint64_t)samples[i].count * samples[i].sum_of_square - sum * sum) / count2);
    }
}

static inline void calc_for_point_on_border(uint16_t* buffer, int x, int y, uint32_t* output, int start_x, int start_y, int end_x, int end_y) {
    int xx, yy, i;
    x -= 24;
    y -= 24;
    for (i = 0; i < 16; i++) {
        samples[i].sum = 0;
        samples[i].sum_of_square = 0;
        samples[i].count = 0;
    }
    for (yy = start_y; yy < end_y; yy++) {
        for (xx = start_x; xx < end_x; xx++) {
            int index = indexes[yy][xx];
            uint32_t value = buffer[x + xx + (y + yy) * width];
            samples[index].sum += value;
            samples[index].sum_of_square += (uint64_t)(value * value);
            samples[index].count++;
        }
    }
    for (i = 0; i < 16; i++) {
        output[2 * i] = samples[i].sum / samples[i].count;
        uint64_t count2 = samples[i].count * samples[i].count;
        uint64_t sum = samples[i].sum;
        output[2 * i + 1] = (uint32_t)sqrt(((uint64_t)samples[i].count * samples[i].sum_of_square - sum * sum) / count2);
    }
}


int main() {
    int i, x, y;
    FILE* f = fopen("../img/raw/G_684_2019_200mGy_Cs137_od5um_co0.5um_40s006.raw", "rb");
    if (f == NULL) {
        fprintf(stderr, "Cannot open a file\n");
        exit(1);
    }
    uint16_t* file_buffer = malloc(2 * width * height);
    int n = fread(file_buffer, 1, 2 * width * height, f);
    if (n != 2 * width * height) {
        fprintf(stderr, "IO error\n");
        exit(1);
    }
    fclose(f);
    for (i = 0; i < width * height; i++) {
        file_buffer[i] = (file_buffer[i] >> 8) | (file_buffer[i] << 8);
    }
    memset(&samples, 0, sizeof(samples));
    for (y = 0; y < sizeof(indexes) / sizeof(indexes[0]); y++) {
        for (x = 0; x < sizeof(indexes[0]) / sizeof(indexes[0][0]); x++) {
            samples[indexes[y][x]].count++;
        }
    }
    uint32_t tmp[32];
    int t = time(NULL);
    for (y = 24; y < 1608-24; y++) {
        for (x = 24; x < 1608-24; x++) {
            calc_for_point(file_buffer, x, y, tmp);
        }
    }
    for (y = 0; y < 24; y++) {
        for (x = 0; x < 24; x++) {
            calc_for_point_on_border(file_buffer, x, y, tmp, 24 - x, 24 - y, 49, 49);
        }
        for (x = 24; x < 1608 - 24; x++) {
            calc_for_point_on_border(file_buffer, x, y, tmp, 0, 24 - y, 49, 49);
        }
        for (x = 1608 - 24; x < 1608; x++) {
            calc_for_point_on_border(file_buffer, x, y, tmp, 0, 24 - y, 49 - (1608 - x), 49);
        }
    }
    for (y = 24; y < 1608-24; y++) {
        for (x = 0; x < 24; x++) {
            calc_for_point_on_border(file_buffer, x, y, tmp, 24 - x, 0, 49, 49);
        }
        for (x = 1608 - 24; x < 1608; x++) {
            calc_for_point_on_border(file_buffer, x, y, tmp, 0, 0, 49 - (1608 - x), 49);
        }
    }
    for (y = 1608 - 24; y < 1608; y++) {
        for (x = 0; x < 24; x++) {
            calc_for_point_on_border(file_buffer, x, y, tmp, 24 - x, 0, 49, 49 - (1608 - y));
        }
        for (x = 24; x < 1608 - 24; x++) {
            calc_for_point_on_border(file_buffer, x, y, tmp, 0, 0, 49, 49 - (1608 - y));
        }
        for (x = 1608 - 24; x < 1608; x++) {
            calc_for_point_on_border(file_buffer, x, y, tmp, 0, 0, 49 - (1608 - x), 49 - (1608 - y));
        }
    }
    printf("time %d\n", (int)(time(NULL) - t));
    for (i = 0; i < 16; i++) {
        printf("%02d: avg %5d, std %5d\n", i, tmp[2 * i], tmp[2 * i + 1]);
    }
    return 0;
}
